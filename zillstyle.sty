\ProvidesPackage{zillstyle}

% --- 基础宏包 ---
\usepackage[UTF8]{ctex}
\usepackage{amsmath, amssymb, amsthm}
\usepackage{xcolor}
\usepackage{tcolorbox}
\usepackage{titlesec}
\usepackage{geometry}
\usepackage[smartEllipses]{markdown}
\usepackage{changepage} 
\usepackage{multicol}   
\usepackage{enumitem}
\usepackage{setspace}
\usepackage{newtxtext,newtxmath} 
\usepackage{booktabs} 
\usepackage{marginnote}
\usepackage{caption}
\usepackage{graphicx}
\usepackage{bm} % 使用 \bm{v} 产生加粗矢量
\usepackage{siunitx}
\sisetup{
  separate-uncertainty = true,
  inter-unit-product = \ensuremath{\cdot},
  tight-spacing = true
}
\usepackage{ragged2e} % 必须加，否则 \RaggedRight 报错
\reversemarginpar     % 必须加，否则边注在右边

\tcbuselibrary{skins, breakable}

% --- 颜色定义 ---
\definecolor{zillTeal}{RGB}{50, 105, 95}     
\definecolor{zillOrange}{RGB}{210, 90, 10}   
\definecolor{zillBlue}{RGB}{30, 100, 170}    
\definecolor{zillDefBg}{RGB}{238, 245, 240}  
\definecolor{zillPropBg}{RGB}{240, 245, 250} 
\definecolor{exHeaderBlue}{RGB}{0, 150, 214} 

% --- 页面布局 (US Letter 8.5x11in) ---
% --- 修改后的页面布局 (更接近 Zill 原版比例) ---
% --- 1. 页面布局深度优化 ---
\geometry{
    paperwidth=8.5in, 
    paperheight=11in, 
    left=2.8in,      % 主栏距离纸张左边缘的距离
    right=0.6in, 
    top=0.7in, 
    bottom=0.7in,
    footskip=0.3in
}

% 必须强制边注反转到左侧空白处
\reversemarginpar 

% 这里的宽度计算非常关键：
% 可用空间是 2.8in，减去边距间隙 0.35in，剩下的就是边注宽度
\setlength{\marginparwidth}{2.1in} 
\setlength{\marginparsep}{0.35in} 


% --- 计数器设置 ---
\newcounter{defn}[section]
\renewcommand{\thedefn}{\thesection.\arabic{defn}}
\newcounter{thrm}[section]
\renewcommand{\thethrm}{\thesection.\arabic{thrm}}
\newcounter{exmp}[section]
\renewcommand{\theexmp}{\arabic{exmp}}

% --- 1. Definition (左栏侧标) ---
\newtcolorbox[use counter=defn]{definition}[1]{
    enhanced, breakable,
    colback=zillDefBg, colframe=zillTeal,
    boxrule=0.5pt, arc=0pt,
    left=2mm, right=2mm, top=3mm,
    fontupper=\setstretch{1.15},
    before upper={\textbf{#1}\par\medskip}, 
    overlay={
        \node[anchor=north east, fill=zillTeal, inner sep=2mm, text=white, 
              font=\bfseries\sffamily, text width=1.2in, align=right] 
        at ([xshift=-5mm]frame.north west) {DEFINITION \thedefn};
    },
    before skip=18pt, after skip=18pt
}

% --- 2. Theorem (左栏侧标) ---
\newtcolorbox[use counter=thrm]{theorem}[1]{
    enhanced, breakable,
    colback=white, colframe=zillOrange,
    boxrule=1.2pt, arc=0pt,
    left=2mm, right=2mm, top=3mm,
    fontupper=\setstretch{1.15},
    before upper={\textbf{#1}\par\medskip},
    overlay={
        \node[anchor=north east, fill=zillOrange, inner sep=2mm, text=white, 
              font=\bfseries\sffamily, text width=1.2in, align=right] 
        at ([xshift=-5mm]frame.north west) {THEOREM \thethrm};
    },
    before skip=18pt, after skip=18pt
}

% --- 3. Example & Solution ---
% --- 1. 全局盒子声明 (务必放在定义外) ---
\newsavebox{\zillbox}

\newenvironment{example}[1][]{
    \refstepcounter{exmp}
    \par\vspace{25pt} % 与上方正文的间距
    \begin{adjustwidth}{0pt}{0pt}
    \setstretch{1.15}
    
    \noindent
    \begingroup
    % --- 头部设计 ---
    % 这里的 \hspace{2em} 控制整体向右平移的距离，你可以根据需要修改
    \hspace*{0em}% 
    % 准备左侧方块
    \sbox{\zillbox}{\colorbox{zillOrange}{\strut\color{white}\bfseries\sffamily EXAMPLE \theexmp}}
    \usebox{\zillbox}
    \hspace{1em} % 方块与标题之间的间距
    % 放置标题文字
    {\large\bfseries\sffamily #1}
    \endgroup
    \par\vspace{10pt} % 标题与下方正文的间距
}{
    % --- 结尾设计：全行橙色横线 ---
    \par\vspace{10pt}
    \noindent{\color{zillOrange}\rule{\linewidth}{1.5pt}} 
    \end{adjustwidth}
    \vspace{15pt} % 与下方正文的间距
}

\newenvironment{solution}{
    \par\medskip
    \noindent{\bfseries\itshape\color{zillOrange} 解}\quad 
}{
    \hfill\ensuremath{\color{zillOrange}\blacksquare}
    \par
}

% --- 4. Properties (蓝色方框，用于总结性质/公式) ---
\newtcolorbox{properties}{
    enhanced, breakable,
    colback=zillPropBg, colframe=zillBlue,
    arc=2pt, boxrule=1pt,
    fonttitle=\bfseries\sffamily, coltitle=zillBlue,
    title=PROPERTIES, 
    attach title to upper,
    after title={\vspace{0.5em}\par\hrule height 0.5pt \vspace{0.5em}},
    left=3mm, right=3mm, top=3mm, bottom=3mm,
    before skip=18pt, after skip=18pt
}

% --- 4. 章节目标 (Objectives) ---
\newtcolorbox{Obje}{
    enhanced, breakable,
    colback=zillTeal!5, colframe=zillTeal,
    arc=0pt, outer arc=0pt, boxrule=0pt, leftrule=3pt,
    fonttitle=\bfseries\sffamily\color{zillTeal},
    title=CHAPTER OBJECTIVES, detach title,
    before upper={\textcolor{zillTeal}{\large\bfseries CHAPTER OBJECTIVES}\vspace{0.5em}\par},
    left=4mm, before skip=15pt, after skip=15pt
}
\newtcolorbox{obje}{
    enhanced, breakable,
    colback=zillTeal!5, colframe=zillTeal,
    arc=0pt, outer arc=0pt, boxrule=0pt, leftrule=3pt,
    fonttitle=\bfseries\sffamily\color{zillTeal},
    title=SECTION OBJECTIVES, detach title,
    before upper={\textcolor{zillTeal}{\large\bfseries SECTION OBJECTIVES}\vspace{0.5em}\par},
    left=4mm, before skip=15pt, after skip=15pt
}

% --- 5. 左栏辅助工具 (Note/Fig/TikZ) ---
% --- 5. 智能左栏辅助工具 (左对齐 + 侧边引导线) ---

% 1. 智能左栏笔记：左侧带引导线，文字左对齐
\newcommand{\leftnote}[2][0pt]{%
  \marginnote{%
    \begin{minipage}{\marginparwidth}
      % 在左侧放置一个 0 宽度的盒子，画出垂直线，不占用正文空间
      \makebox[0pt][r]{\color{zillTeal!30}\rule[-0.8ex]{2.5pt}{3ex}\hspace{8pt}}%
      \RaggedRight\setstretch{1.1}\small\itshape\color{zillTeal}%
      #2
    \end{minipage}
  }[#1]
}

% 2. 智能左栏图片：图片与图注左对齐
\newcommand{\leftfig}[3][0pt]{%
  \marginnote{%
    \begin{minipage}{\marginparwidth}
      \flushleft % 确保整体靠左
      \includegraphics[width=\linewidth]{#2}
      \vspace{4pt}
      \captionof{figure}{\RaggedRight\footnotesize #3} % 图注也左对齐
    \end{minipage}
  }[#1]
}

% 3. 智能左栏 TikZ：保持居中或左对齐
\newcommand{\lefttikz}[3][0pt]{%
  \marginnote{% 
    \begin{minipage}{\marginparwidth}
      \flushleft % 整体靠左
      \setstretch{1.0}\small
      {#2} % TikZ 绘图
      \vspace{4pt}
      \captionof{figure}{\RaggedRight\footnotesize #3}
    \end{minipage}
  }[#1]
}

% --- 6. 习题环境 (Exercises) ---
\newlist{exerciseList}{enumerate}{2}
\setlist[exerciseList,1]{label=\bfseries\arabic*., labelsep=0.5em, leftmargin=2em, itemsep=1.2ex, before=\small\setstretch{1.1}}

\newenvironment{exercises}[1]{
    % adjustwidth 的第一个参数对应新的左边距偏移量
    \begin{adjustwidth}{-2.2in}{0in} 
    \setstretch{1.1}
    \noindent{\Large\bfseries\color{zillTeal} EXERCISES #1} 
    % ... 后面保持不变 ...
    \hfill 
    \smash{\raisebox{-2pt}{\footnotesize\color{white}\colorbox{exHeaderBlue!80}{Answers on ANS-1}}}
    \vspace{2pt}\hrule height 1.5pt\vspace{10pt}
    \begin{multicols}{2}
}{
    \end{multicols}\end{adjustwidth}
}
% --- 6*. Caution (警告框) ---
\newtcolorbox{caution}[1]{
    enhanced, breakable,
    colback=white, colframe=red!75!black,
    boxrule=0.5pt, arc=2pt,
    left=8mm, fontupper=\small,
    before upper={\textbf{\color{red!75!black} 注意事项：#1}\par\medskip},
    overlay={
        \node[anchor=north west] at ([xshift=2mm, yshift=-2mm]frame.north west) 
        {\scalebox{1.5}{⚠️}};
    },
    before skip=12pt, after skip=12pt
}

% --- 7. 标题格式定制 ---
\titleformat{\chapter}[display]
  {\normalfont\huge\bfseries\color{zillTeal}}
  {\llap{\tcolorbox[colback=zillTeal,colframe=zillTeal,width=1.8cm,sharp corners, fontupper=\color{white}\Huge\bfseries,halign=center] \thechapter \endtcolorbox\hspace{0.8in}}}
  {-22pt}
  {\titlerule[2.5pt]\vspace{2pt}\titlerule[1pt]\vspace{1ex}\filright}

\titleformat{\section}
  {\normalfont\Large\bfseries\color{zillTeal}}
  {\thesection}{1em}{}[{\titlerule[0.8pt]}]

\titleformat{\subsection}
  {\normalfont\large\bfseries}
  {\color{zillBlue}\rule[0.1ex]{0.7em}{0.7em}}
  {0.5em}{}

% --- 11. 语义化文字宏 (加粗并适配样式) ---

% 通用加粗关键词 (使用无衬线加粗，更有教材感)
\newcommand{\kwd}[1]{\textbf{\textsf{#1}}}

% 物理意义专用标签 (加粗 + 颜色)
\newcommand{\meaninglabel}{\textbf{\color{zillTeal}物理意义：}}

% 注意事项专用标签 (加粗 + 橙色)
\newcommand{\notelabel}{\textbf{\color{zillOrange}注意：}}

% 结论/重点文字
\newcommand{\keypoint}[1]{\begingroup\bfseries\color{zillBlue}#1\endgroup}

\endinput
